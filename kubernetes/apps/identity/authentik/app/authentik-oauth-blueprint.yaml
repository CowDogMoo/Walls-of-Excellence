---
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-oauth-blueprint
  namespace: identity
  labels:
    blueprints.goauthentik.io/instantiate: "true"
data:
  oauth-providers.yaml: |
    version: 1
    metadata:
      name: OAuth Providers Configuration
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    context:
      grafana_client_secret: !Env GRAFANA_CLIENT_SECRET
      traefik_client_secret: !Env TRAEFIK_CLIENT_SECRET
      weave_gitops_client_secret: !Env WEAVE_GITOPS_CLIENT_SECRET
      guacamole_client_secret: !Env GUACAMOLE_CLIENT_SECRET
      tailscale_client_secret: !Env TAILSCALE_CLIENT_SECRET
      homeassistant_test_client_secret: !Env HOMEASSISTANT_TEST_CLIENT_SECRET
    entries:
      # Groups for role mapping
      - model: authentik_core.group
        id: grafana-admins
        identifiers:
          name: Grafana Admins
        state: present
        attrs:
          name: Grafana Admins

      - model: authentik_core.group
        id: grafana-editors
        identifiers:
          name: Grafana Editors
        state: present
        attrs:
          name: Grafana Editors

      - model: authentik_core.group
        id: traefik-admins
        identifiers:
          name: Traefik Admins
        state: present
        attrs:
          name: Traefik Admins

      - model: authentik_core.group
        id: weave-gitops-admins
        identifiers:
          name: Weave GitOps Admins
        state: present
        attrs:
          name: Weave GitOps Admins

      - model: authentik_core.group
        id: guacamole-users
        identifiers:
          name: Guacamole Users
        state: present
        attrs:
          name: Guacamole Users

      - model: authentik_core.group
        id: tailscale-users
        identifiers:
          name: Tailscale Users
        state: present
        attrs:
          name: Tailscale Users

      - model: authentik_core.group
        id: homeassistant-test-users
        identifiers:
          name: Home Assistant Test Users
        state: present
        attrs:
          name: Home Assistant Test Users

      - model: authentik_core.group
        id: homeassistant-test-admins
        identifiers:
          name: Home Assistant Test Admins
        state: present
        attrs:
          name: Home Assistant Test Admins

      # Custom Scope Mapping for Home Assistant groups and admin status
      - model: authentik_providers_oauth2.scopemapping
        id: homeassistant-groups-scope
        identifiers:
          scope_name: groups
          name: Home Assistant Groups and Admin
        state: present
        attrs:
          name: Home Assistant Groups and Admin
          scope_name: groups
          description: "Provides group membership and admin status for Home Assistant"
          expression: |
            return {
              "is_admin": ak_is_group_member(request.user, name="Home Assistant Test Admins"),
              "groups": [group.name for group in request.user.ak_groups.all()]
            }

      # OAuth2 Provider for Grafana
      - model: authentik_providers_oauth2.oauth2provider
        id: grafana-provider
        identifiers:
          name: Grafana
        state: present
        attrs:
          name: Grafana
          client_id: grafana
          client_secret: !Context grafana_client_secret
          client_type: confidential
          authentication_flow: !Find [authentik_flows.flow, [slug, passwordless-webauthn]]
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          redirect_uris:
            - matching_mode: strict
              url: "https://grafana.techvomit.xyz/login/generic_oauth"
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
          sub_mode: hashed_user_id
          access_code_validity: "minutes=1"
          access_token_validity: "minutes=5"
          refresh_token_validity: "days=30"

      # Proxy Provider for Traefik Dashboard (Forward Auth)
      - model: authentik_providers_proxy.proxyprovider
        id: traefik-provider
        identifiers:
          name: Traefik Dashboard
        state: present
        attrs:
          name: Traefik Dashboard
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: "https://traefik.techvomit.xyz"
          cookie_domain: "techvomit.xyz"
          skip_path_regex: ""
          basic_auth_enabled: false
          intercept_header_auth: true
          access_token_validity: "minutes=5"
          refresh_token_validity: "days=30"

      # OAuth2 Provider for Weave GitOps
      - model: authentik_providers_oauth2.oauth2provider
        id: weave-gitops-provider
        identifiers:
          name: Weave GitOps
        state: present
        attrs:
          name: Weave GitOps
          client_id: weave-gitops
          client_secret: !Context weave_gitops_client_secret
          client_type: confidential
          authentication_flow: !Find [authentik_flows.flow, [slug, passwordless-webauthn]]
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Internal JWT Certificate]]
          redirect_uris:
            - matching_mode: strict
              url: "https://weave.techvomit.xyz/oauth2/callback"
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
          sub_mode: hashed_user_id
          access_code_validity: "minutes=1"
          access_token_validity: "minutes=5"
          refresh_token_validity: "days=30"

      # Proxy Provider for Guacamole (Forward Auth)
      - model: authentik_providers_proxy.proxyprovider
        id: guacamole-provider
        identifiers:
          name: Guacamole
        state: present
        attrs:
          name: Guacamole
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: "https://guacamole.techvomit.xyz"
          cookie_domain: "techvomit.xyz"
          skip_path_regex: ""
          basic_auth_enabled: false
          intercept_header_auth: true
          access_token_validity: "minutes=5"
          refresh_token_validity: "days=30"

      # OAuth2 Provider for Tailscale
      - model: authentik_providers_oauth2.oauth2provider
        id: tailscale-provider
        identifiers:
          name: Tailscale
        state: present
        attrs:
          name: Tailscale
          client_id: tailscale
          client_secret: !Context tailscale_client_secret
          client_type: confidential
          authentication_flow: !Find [authentik_flows.flow, [slug, passwordless-webauthn]]
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Internal JWT Certificate]]
          redirect_uris:
            - matching_mode: strict
              url: "https://login.tailscale.com/a/oauth_response"
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
          sub_mode: hashed_user_id
          access_code_validity: "minutes=1"
          access_token_validity: "minutes=5"
          refresh_token_validity: "days=30"

      # OAuth2 Provider for Home Assistant Test
      - model: authentik_providers_oauth2.oauth2provider
        id: homeassistant-test-provider
        identifiers:
          name: Home Assistant Test
        state: present
        attrs:
          name: Home Assistant Test
          client_id: home-assistant-test
          client_secret: !Context homeassistant_test_client_secret
          client_type: confidential
          authentication_flow: !Find [authentik_flows.flow, [slug, passwordless-webauthn]]
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Internal JWT Certificate]]
          redirect_uris:
            - matching_mode: strict
              url: "https://ha-test.techvomit.xyz/auth/oidc/callback"
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
            - !KeyOf homeassistant-groups-scope
          sub_mode: hashed_user_id
          access_code_validity: "minutes=1"
          access_token_validity: "minutes=5"
          refresh_token_validity: "days=30"

      # Application for Grafana
      - model: authentik_core.application
        id: grafana-app
        identifiers:
          slug: grafana
        state: present
        attrs:
          name: Grafana
          slug: grafana
          provider: !KeyOf grafana-provider
          meta_launch_url: "https://grafana.techvomit.xyz"
          meta_description: "Grafana Monitoring Dashboard"
          policy_engine_mode: any

      # Application for Traefik Dashboard
      - model: authentik_core.application
        id: traefik-app
        identifiers:
          slug: traefik-dashboard
        state: present
        attrs:
          name: Traefik Dashboard
          slug: traefik-dashboard
          provider: !KeyOf traefik-provider
          meta_launch_url: "https://traefik.techvomit.xyz"
          meta_description: "Traefik Ingress Controller Dashboard"
          policy_engine_mode: any

      # Application for Weave GitOps
      - model: authentik_core.application
        id: weave-gitops-app
        identifiers:
          slug: weave-gitops
        state: present
        attrs:
          name: Weave GitOps
          slug: weave-gitops
          provider: !KeyOf weave-gitops-provider
          meta_launch_url: "https://weave.techvomit.xyz"
          meta_description: "Weave GitOps Dashboard - GitOps Management"
          policy_engine_mode: any

      # Application for Guacamole
      - model: authentik_core.application
        id: guacamole-app
        identifiers:
          slug: guacamole
        state: present
        attrs:
          name: Guacamole
          slug: guacamole
          provider: !KeyOf guacamole-provider
          meta_launch_url: "https://guacamole.techvomit.xyz"
          meta_description: "Apache Guacamole - Remote Desktop Gateway"
          policy_engine_mode: any

      # Application for Tailscale
      - model: authentik_core.application
        id: tailscale-app
        identifiers:
          slug: tailscale
        state: present
        attrs:
          name: Tailscale
          slug: tailscale
          provider: !KeyOf tailscale-provider
          meta_launch_url: "https://login.tailscale.com"
          meta_description: "Tailscale Mesh VPN - Secure Network Access"
          policy_engine_mode: any

      # Application for Home Assistant Test
      - model: authentik_core.application
        id: homeassistant-test-app
        identifiers:
          slug: home-assistant-test
        state: present
        attrs:
          name: Home Assistant Test
          slug: home-assistant-test
          provider: !KeyOf homeassistant-test-provider
          meta_launch_url: "https://ha-test.techvomit.xyz"
          meta_description: "Home Assistant Test Instance - Smart Home Testing"
          policy_engine_mode: any

      # Expression policy for group checking
      - model: authentik_policies_expression.expressionpolicy
        id: traefik-admin-policy
        identifiers:
          name: traefik-admin-policy
        state: present
        attrs:
          name: traefik-admin-policy
          expression: |
            return ak_is_group_member(request.user, name="Traefik Admins")

      - model: authentik_policies_expression.expressionpolicy
        id: weave-gitops-admin-policy
        identifiers:
          name: weave-gitops-admin-policy
        state: present
        attrs:
          name: weave-gitops-admin-policy
          expression: |
            return ak_is_group_member(request.user, name="Weave GitOps Admins")

      - model: authentik_policies_expression.expressionpolicy
        id: guacamole-user-policy
        identifiers:
          name: guacamole-user-policy
        state: present
        attrs:
          name: guacamole-user-policy
          expression: |
            return ak_is_group_member(request.user, name="Guacamole Users")

      - model: authentik_policies_expression.expressionpolicy
        id: tailscale-user-policy
        identifiers:
          name: tailscale-user-policy
        state: present
        attrs:
          name: tailscale-user-policy
          expression: |
            return ak_is_group_member(request.user, name="Tailscale Users")

      - model: authentik_policies_expression.expressionpolicy
        id: homeassistant-test-user-policy
        identifiers:
          name: homeassistant-test-user-policy
        state: present
        attrs:
          name: homeassistant-test-user-policy
          expression: |
            return ak_is_group_member(request.user, name="Home Assistant Test Users")

      # Policy binding for Traefik application
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf traefik-app
          policy: !KeyOf traefik-admin-policy
          order: 0
        state: present
        attrs:
          enabled: true
          order: 0

      # Policy binding for Weave GitOps application
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf weave-gitops-app
          policy: !KeyOf weave-gitops-admin-policy
          order: 0
        state: present
        attrs:
          enabled: true
          order: 0

      # Policy binding for Guacamole application
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf guacamole-app
          policy: !KeyOf guacamole-user-policy
          order: 0
        state: present
        attrs:
          enabled: true
          order: 0

      # Policy binding for Tailscale application
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf tailscale-app
          policy: !KeyOf tailscale-user-policy
          order: 0
        state: present
        attrs:
          enabled: true
          order: 0

      # Policy binding for Home Assistant Test application
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf homeassistant-test-app
          policy: !KeyOf homeassistant-test-user-policy
          order: 0
        state: present
        attrs:
          enabled: true
          order: 0

      # Assign provider to embedded outpost
      - model: authentik_outposts.outpost
        identifiers:
          name: authentik Embedded Outpost
        attrs:
          providers:
            - !KeyOf traefik-provider
            - !KeyOf guacamole-provider
