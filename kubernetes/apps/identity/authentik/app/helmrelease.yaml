---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: identity
spec:
  interval: 30m
  chart:
    spec:
      chart: authentik
      version: 2024.10.2
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
  install:
    timeout: 15m
    remediation:
      retries: 3
  upgrade:
    timeout: 15m
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_SECRET_KEY
      targetPath: authentik.secret_key
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_POSTGRESQL_PASSWORD
      targetPath: authentik.postgresql.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_POSTGRESQL_PASSWORD
      targetPath: postgresql.auth.postgresPassword
  values:
    # Global configuration
    global:
      storageClass: nfs-client
      # Global environment variables
      env:
        - name: AUTHENTIK_LISTEN__HTTP
          value: "0.0.0.0:9000"
        - name: AUTHENTIK_LISTEN__METRICS
          value: "0.0.0.0:9300"
      # Shared memory volume configuration
      volumes:
        - name: dshm
          emptyDir: {}

    # Authentik specific configuration
    authentik:
      log_level: info

      # Error reporting
      error_reporting:
        enabled: false

      # PostgreSQL configuration
      postgresql:
        host: "authentik-postgresql"
        name: "authentik"
        user: "authentik"

    # Server configuration
    server:
      # Number of server replicas
      replicas: 1

      # Resources
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 1Gi
          cpu: 1000m

      # Probes with appropriate timeouts for authentik startup
      startupProbe:
        httpGet:
          path: /-/health/live/
          port: 9000
        initialDelaySeconds: 90
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 60

      livenessProbe:
        httpGet:
          path: /-/health/live/
          port: 9000
        initialDelaySeconds: 60
        periodSeconds: 30
        timeoutSeconds: 10
        failureThreshold: 3

      readinessProbe:
        httpGet:
          path: /-/health/ready/
          port: 9000
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3

      # Ingress configuration
      ingress:
        enabled: true
        ingressClassName: ingress-traefik
        hosts:
          - &host auth.techvomit.xyz
        paths:
          - /
        pathType: Prefix
        tls:
          - hosts:
              - *host
            secretName: techvomit-xyz-production-tls

      # Metrics
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

    # Worker configuration
    worker:
      # Enable worker
      enabled: true

      # Number of worker replicas
      replicas: 1

      # Resources
      resources:
        requests:
          memory: 512Mi
          cpu: 100m
        limits:
          memory: 1Gi
          cpu: 500m

    # PostgreSQL subchart configuration
    postgresql:
      enabled: true

      image:
        registry: docker.io
        repository: postgres # Official postgres works!
        tag: "17-alpine"

      # Authentication
      auth:
        username: authentik
        database: authentik
        existingSecret: authentik-secrets
        secretKeys:
          adminPasswordKey: AUTHENTIK_POSTGRESQL_PASSWORD
          userPasswordKey: AUTHENTIK_POSTGRESQL_PASSWORD

      # Primary instance configuration
      primary:
        persistence:
          enabled: true
          storageClass: nfs-client
          size: 8Gi

        # Resources for PostgreSQL
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m

    # Redis subchart configuration
    redis:
      enabled: true

      image:
        registry: docker.io
        repository: bitnamilegacy/redis
        tag: "7.2"

      architecture: standalone

      auth:
        enabled: false

      master:
        persistence:
          enabled: true
          storageClass: nfs-client
          size: 1Gi

        # Resources for Redis
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m
