---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: identity
spec:
  interval: 30m
  chart:
    spec:
      chart: authentik
      version: 2025.12.1
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: identity
  install:
    timeout: 15m
    remediation:
      retries: 3
  upgrade:
    timeout: 15m
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_SECRET_KEY
      targetPath: authentik.secret_key
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_POSTGRESQL_PASSWORD
      targetPath: authentik.postgresql.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: GRAFANA_CLIENT_SECRET
      targetPath: blueprints.context.grafana_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: TRAEFIK_CLIENT_SECRET
      targetPath: blueprints.context.traefik_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: WEAVE_GITOPS_CLIENT_SECRET
      targetPath: blueprints.context.weave_gitops_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: GUACAMOLE_CLIENT_SECRET
      targetPath: blueprints.context.guacamole_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: TAILSCALE_CLIENT_SECRET
      targetPath: blueprints.context.tailscale_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: HOMEASSISTANT_TEST_CLIENT_SECRET
      targetPath: blueprints.context.homeassistant_test_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: HOMEASSISTANT_CLIENT_SECRET
      targetPath: blueprints.context.homeassistant_client_secret
    - kind: Secret
      name: authentik-secrets
      valuesKey: SYNOLOGY_NAS_CLIENT_SECRET
      targetPath: blueprints.context.synology_nas_client_secret
  values:
    global:
      image: {}

      # Additional volumes for all pods (server and worker)
      # Note: Blueprint ConfigMaps are automatically mounted by the chart
      additionalVolumes:
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 256Mi
      additionalVolumeMounts:
        - name: dshm
          mountPath: /dev/shm

    authentik:
      log_level: info
      error_reporting:
        enabled: false
      postgresql:
        host: authentik-postgresql
        name: authentik
        user: authentik

    blueprints:
      configMaps:
        - authentik-oauth-blueprint
        - authentik-passkeys-blueprint

    server:
      replicas: 1
      envFrom:
        - secretRef:
            name: authentik-secrets
      resources:
        requests:
          memory: 776Mi
          cpu: 300m
        limits:
          memory: 1Gi
          cpu: 750m

      # Spread authentik components across different nodes to prevent CPU saturation
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            # Avoid same component (multiple server replicas)
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: authentik
                    app.kubernetes.io/name: authentik
                    app.kubernetes.io/component: server
                topologyKey: kubernetes.io/hostname
            # Avoid worker pods
            - weight: 90
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: authentik
                    app.kubernetes.io/name: authentik
                    app.kubernetes.io/component: worker
                topologyKey: kubernetes.io/hostname
            # Avoid postgresql pods
            - weight: 90
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: authentik
                    app.kubernetes.io/name: postgresql
                    app.kubernetes.io/component: primary
                topologyKey: kubernetes.io/hostname

      startupProbe:
        httpGet:
          path: /-/health/live/
          port: 9000
        initialDelaySeconds: 90
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 60

      livenessProbe:
        httpGet:
          path: /-/health/live/
          port: 9000
        initialDelaySeconds: 60
        periodSeconds: 30
        timeoutSeconds: 10
        failureThreshold: 3

      readinessProbe:
        httpGet:
          path: /-/health/ready/
          port: 9000
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3

      ingress:
        enabled: true
        ingressClassName: ingress-traefik
        hosts:
          - &host auth.techvomit.xyz
        paths:
          - /
        pathType: Prefix
        tls:
          - hosts:
              - *host
            secretName: techvomit-xyz-production-tls

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

    worker:
      enabled: true
      replicas: 1
      envFrom:
        - secretRef:
            name: authentik-secrets

      resources:
        requests:
          memory: 488Mi
          cpu: 49m
        limits:
          memory: 700Mi
          cpu: 200m

      # Spread authentik components across different nodes to prevent CPU saturation
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            # Avoid same component (multiple worker replicas)
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: authentik
                    app.kubernetes.io/name: authentik
                    app.kubernetes.io/component: worker
                topologyKey: kubernetes.io/hostname
            # Avoid server pods
            - weight: 90
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: authentik
                    app.kubernetes.io/name: authentik
                    app.kubernetes.io/component: server
                topologyKey: kubernetes.io/hostname
            # Avoid postgresql pods
            - weight: 90
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: authentik
                    app.kubernetes.io/name: postgresql
                    app.kubernetes.io/component: primary
                topologyKey: kubernetes.io/hostname

      startupProbe:
        exec:
          command:
            - sh
            - -c
            - test -f /dev/shm/authentik-worker.pid && kill -0 $(cat /dev/shm/authentik-worker.pid)
        initialDelaySeconds: 120
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 90
        successThreshold: 1

      livenessProbe:
        exec:
          command:
            - sh
            - -c
            - test -f /dev/shm/authentik-worker.pid && kill -0 $(cat /dev/shm/authentik-worker.pid)
        initialDelaySeconds: 60
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3
        successThreshold: 1

      readinessProbe:
        exec:
          command:
            - sh
            - -c
            - test -f /dev/shm/authentik-worker.pid && kill -0 $(cat /dev/shm/authentik-worker.pid)
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3
        successThreshold: 1

      # Worker metrics disabled - authentik workers do not expose metrics endpoint
      metrics:
        enabled: false
        serviceMonitor:
          enabled: false

    postgresql:
      enabled: true

      auth:
        username: authentik
        database: authentik
        existingSecret: authentik-secrets
        secretKeys:
          adminPasswordKey: AUTHENTIK_POSTGRESQL_PASSWORD
          userPasswordKey: AUTHENTIK_POSTGRESQL_PASSWORD

      primary:
        persistence:
          enabled: true
          storageClass: local-path
          size: 8Gi

        resources:
          requests:
            memory: 391Mi
            cpu: 271m
          limits:
            memory: 600Mi
            cpu: 500m

        # Pin PostgreSQL to k8s9 for fast NVMe storage
        nodeSelector:
          kubernetes.io/hostname: k8s9

        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              # Avoid same component (postgresql HA replicas)
              - weight: 1
                podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/instance: authentik
                      app.kubernetes.io/name: postgresql
                      app.kubernetes.io/component: primary
                  topologyKey: kubernetes.io/hostname
              # Avoid server pods
              - weight: 90
                podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/instance: authentik
                      app.kubernetes.io/name: authentik
                      app.kubernetes.io/component: server
                  topologyKey: kubernetes.io/hostname
              # Avoid worker pods
              - weight: 90
                podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/instance: authentik
                      app.kubernetes.io/name: authentik
                      app.kubernetes.io/component: worker
                  topologyKey: kubernetes.io/hostname
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: kubernetes.io/hostname
            whenUnsatisfiable: ScheduleAnyway
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql
                app.kubernetes.io/component: primary

    redis:
      enabled: false
