---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  annotations:
    metadata.weave.works/description:
      This is the Weave GitOps Dashboard.  It provides
      a simple way to get insights into your GitOps workloads.
  name: weave-gitops
  namespace: flux-system
spec:
  interval: 15m
  chartRef:
    kind: OCIRepository
    name: weave-gitops
    namespace: flux-system
  maxHistory: 3
  install:
    timeout: 10m
    replace: true
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    remediation:
      remediateLastFailure: true
      retries: 3
      strategy: rollback
    cleanupOnFail: true
    crds: CreateReplace
  rollback:
    recreate: true
    force: true
    cleanupOnFail: true
  uninstall:
    keepHistory: false
  values:
    image:
      tag: "0.38.0"
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 512Mi
    livenessProbe:
      httpGet:
        path: /
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      httpGet:
        path: /
        port: http
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    env:
      WEAVE_GITOPS_FEATURE_TELEMETRY: "true"
    adminUser:
      create: true
      username: admin
    oidcSecret:
      create: true
      issuerURL: https://auth.techvomit.xyz/application/o/weave-gitops/
      clientID: weave-gitops
      redirectURL: https://weave.techvomit.xyz/oauth2/callback
      tokenDuration: 1h
    ingress:
      annotations:
        external-dns.alpha.kubernetes.io/hostname: weave.techvomit.xyz
      enabled: true
      className: ingress-traefik
      hosts:
        - host: &host weave.techvomit.xyz
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - *host
          secretName: techvomit-xyz-production-tls
    networkPolicy:
      create: true
    rbac:
      create: true
      # Restrict impersonation to only explicitly allowed OIDC users
      # This list should match users in oidc-user-clusterrolebinding.yaml
      impersonationResourceNames:
        - admin
        - jayson.e.grace@gmail.com
      additionalRules:
        - apiGroups: [""]
          resources:
            ["secrets", "pods", "events", "namespaces", "serviceaccounts"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["apps"]
          resources:
            ["deployments", "replicasets", "statefulsets", "daemonsets"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["kustomize.toolkit.fluxcd.io"]
          resources: ["kustomizations"]
          verbs: ["get", "list", "watch", "patch"]
        - apiGroups: ["helm.toolkit.fluxcd.io"]
          resources: ["helmreleases"]
          verbs: ["get", "list", "watch", "patch"]
        - apiGroups: ["source.toolkit.fluxcd.io"]
          resources:
            [
              "buckets",
              "helmcharts",
              "gitrepositories",
              "helmrepositories",
              "ocirepositories",
            ]
          verbs: ["get", "list", "watch", "patch"]
        - apiGroups: [""]
          resources: ["events"]
          verbs: ["get", "watch", "list"]
        - apiGroups: ["networking.k8s.io"]
          resources: ["ingresses"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["rbac.authorization.k8s.io"]
          resources:
            ["clusterroles", "roles", "clusterrolebindings", "rolebindings"]
          verbs: ["get", "list"]
        - apiGroups: ["apiextensions.k8s.io"]
          resources: ["customresourcedefinitions"]
          verbs: ["get", "list"]
  valuesFrom:
    - kind: Secret
      name: weave-gitops-secret
      valuesKey: ADMIN_PASSWORD
      targetPath: adminUser.passwordHash
    - kind: Secret
      name: authentik-secrets
      valuesKey: WEAVE_GITOPS_CLIENT_SECRET
      targetPath: oidcSecret.clientSecret
