---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: guacamole-connection-k8s1
  namespace: guacamole
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: guacamole-connection-k8s1
    template:
      engineVersion: v2
      data:
        connection.yaml: |
          name: {{ .name | quote }}
          protocol: "ssh"
          parameters:
            hostname: {{ .hostname | quote }}
            {{- if .port }}
            port: {{ .port | quote }}
            {{- else }}
            port: "22"
            {{- end }}
            {{- if .username }}
            username: {{ .username | quote }}
            {{- end }}
            {{- if .private_key }}
            private-key: {{ .private_key | quote }}
            {{- end }}
            {{- if .passphrase }}
            passphrase: {{ .passphrase | quote }}
            {{- end }}
            enable-sftp: "true"
            {{- if .username }}
            sftp-root-directory: {{ printf "/home/%s" .username | quote }}
            {{- end }}
            color-scheme: "green-black"
            font-name: "monospace"
            font-size: "12"
            enable-clipboard: "true"
          users:
            {{- if .users }}
            {{- $users := .users }}
            {{- range $user := split "," $users }}
            {{- if $user }}
            - {{ $user | trim | quote }}
            {{- end }}
            {{- end }}
            {{- end }}
          permissions:
            {{- if .permissions }}
            {{- $perms := .permissions }}
            {{- range $perm := split "," $perms }}
            {{- if $perm }}
            - {{ $perm | trim | quote }}
            {{- end }}
            {{- end }}
            {{- else }}
            - "READ"
            {{- end }}
  dataFrom:
    - extract:
        key: guacamole-k8s1
