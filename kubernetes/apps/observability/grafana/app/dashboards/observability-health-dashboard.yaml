---
apiVersion: v1
kind: ConfigMap
metadata:
  name: observability-health-dashboard
  namespace: observability
  labels:
    grafana_dashboard: "1"
  annotations:
    grafana_folder: "Observability"
    dashboard-version: "1.0.0"
    last-modified: "2025-01-26"
    description: "Monitor observability stack health to establish baselines for Phase 2 decisions"
data:
  observability-health.json: |
    {
      "uid": "observability-health",
      "title": "Observability Stack - Health Monitoring",
      "description": "Monitor Prometheus, Loki, and Grafana performance to make data-driven infrastructure decisions",
      "tags": ["observability", "prometheus", "loki", "grafana", "performance"],
      "timezone": "browser",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "1m",
      "time": {
        "from": "now-6h",
        "to": "now"
      },
      "templating": {
        "list": [
          {
            "name": "datasource",
            "type": "datasource",
            "query": "prometheus",
            "current": {
              "text": "Prometheus",
              "value": "prometheus"
            },
            "hide": 0
          },
          {
            "name": "time_range",
            "type": "custom",
            "query": "1h,6h,12h,24h,7d,14d,30d",
            "current": {
              "text": "6h",
              "value": "6h"
            },
            "multi": false,
            "includeAll": false
          }
        ]
      },
      "panels": [
        {
          "id": 1,
          "title": "üìä Dashboard Overview",
          "type": "text",
          "gridPos": { "h": 4, "w": 24, "x": 0, "y": 0 },
          "options": {
            "mode": "markdown",
            "content": "# Observability Stack Health Monitoring\n\n
              This dashboard helps determine if infrastructure changes are needed
              based on **measured performance**.\n\n
              ## Decision Criteria (from Final Consensus):\n\n
              ### Prometheus NFS Storage\n
              - Keep NFS if p99 fsync < 100ms\n
              - Monitor if p99 fsync = 100-500ms\n
              - Migrate to local storage if p99 fsync > 1s\n\n
              ### Loki Filesystem Storage\n
              - Keep filesystem if storage < 10GB stable AND query p95 < 5s\n
              - Investigate if flush_queue > 100\n
              - Consider MinIO if growth > 1GB/day unsustainable\n\n
              ### Recording Rules\n
              - Not needed if query p95 < 1s\n
              - Monitor specific queries if query p95 = 1-5s\n
              - Add targeted rules if query p95 > 5s\n\n
              ---\n\n
              **Monitor for 2 weeks, then make data-driven decisions.**"
          }
        },
        {
          "id": 100,
          "title": "Prometheus Health",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 4 },
          "collapsed": false
        },
        {
          "id": 101,
          "title": "WAL Fsync Duration (p99) - Threshold: 100ms",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 5 },
          "targets": [
            {
              "expr": "histogram_quantile(0.99, rate(prometheus_tsdb_wal_fsync_duration_seconds_bucket{namespace=\"observability\"}[5m])) * 1000",
              "legendFormat": "p99 fsync duration (ms)",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10,
                "spanNulls": false,
                "thresholdsStyle": {
                  "mode": "line"
                }
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 100, "color": "yellow" },
                  { "value": 500, "color": "orange" },
                  { "value": 1000, "color": "red" }
                ]
              }
            }
          },
          "options": {
            "legend": {
              "displayMode": "list",
              "placement": "bottom"
            },
            "tooltip": { "mode": "single" }
          }
        },
        {
          "id": 102,
          "title": "WAL Fsync Status",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 5 },
          "targets": [
            {
              "expr": "histogram_quantile(0.99, rate(prometheus_tsdb_wal_fsync_duration_seconds_bucket{namespace=\"observability\"}[5m])) * 1000",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 100, "color": "yellow" },
                  { "value": 500, "color": "orange" },
                  { "value": 1000, "color": "red" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "area",
            "colorMode": "background",
            "textMode": "value_and_name",
            "reduceOptions": {
              "values": false,
              "calcs": ["lastNotNull"]
            }
          }
        },
        {
          "id": 103,
          "title": "NFS Decision",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 5 },
          "targets": [
            {
              "expr": "histogram_quantile(0.99, rate(prometheus_tsdb_wal_fsync_duration_seconds_bucket{namespace=\"observability\"}[5m])) * 1000",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "mappings": [
                {
                  "type": "range",
                  "options": {
                    "from": 0,
                    "to": 100,
                    "result": {
                      "text": "‚úÖ Keep NFS",
                      "color": "green"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 100,
                    "to": 500,
                    "result": {
                      "text": "‚ö†Ô∏è Monitor",
                      "color": "yellow"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 500,
                    "to": 1000,
                    "result": {
                      "text": "‚ö†Ô∏è Watch Closely",
                      "color": "orange"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 1000,
                    "to": 999999,
                    "result": {
                      "text": "üî¥ Migrate SSD",
                      "color": "red"
                    }
                  }
                }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "none",
            "colorMode": "background",
            "textMode": "name",
            "reduceOptions": {
              "values": false,
              "calcs": ["lastNotNull"]
            }
          }
        },
        {
          "id": 104,
          "title": "Query Duration (p95) - Threshold: 1s",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 9 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(prometheus_http_request_duration_seconds_bucket{namespace=\"observability\", handler=\"query\"}[5m]))",
              "legendFormat": "p95 query duration",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10,
                "thresholdsStyle": {
                  "mode": "line"
                }
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 1, "color": "yellow" },
                  { "value": 5, "color": "red" }
                ]
              }
            }
          }
        },
        {
          "id": 105,
          "title": "Prometheus Storage Usage",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 13 },
          "targets": [
            {
              "expr": "prometheus_tsdb_storage_blocks_bytes{namespace=\"observability\"} / 1024 / 1024 / 1024",
              "legendFormat": "Storage (GB)",
              "refId": "A"
            },
            {
              "expr": "50",
              "legendFormat": "Max (50GB)",
              "refId": "B"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "gbytes",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10
              }
            }
          }
        },
        {
          "id": 106,
          "title": "Prometheus Compactions",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 17 },
          "targets": [
            {
              "expr": "rate(prometheus_tsdb_compactions_total{namespace=\"observability\"}[5m])",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "color": { "mode": "thresholds" },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 0.1, "color": "yellow" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "area",
            "textMode": "value_and_name"
          }
        },
        {
          "id": 107,
          "title": "Recording Rules Needed?",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 17 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(prometheus_http_request_duration_seconds_bucket{namespace=\"observability\", handler=\"query\"}[5m]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "mappings": [
                {
                  "type": "range",
                  "options": {
                    "from": 0,
                    "to": 1,
                    "result": {
                      "text": "‚úÖ Not Needed",
                      "color": "green"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 1,
                    "to": 5,
                    "result": {
                      "text": "‚ö†Ô∏è Monitor",
                      "color": "yellow"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 5,
                    "to": 999999,
                    "result": {
                      "text": "üî¥ Add Rules",
                      "color": "red"
                    }
                  }
                }
              ]
            }
          },
          "options": {
            "graphMode": "none",
            "colorMode": "background",
            "textMode": "name"
          }
        },
        {
          "id": 200,
          "title": "Loki Health",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 21 },
          "collapsed": false
        },
        {
          "id": 201,
          "title": "Loki Query Latency (p95) - Threshold: 5s",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 22 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(loki_request_duration_seconds_bucket{namespace=\"observability\", route=~\".*query.*\"}[5m])))",
              "legendFormat": "p95 query latency",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10,
                "thresholdsStyle": {
                  "mode": "line"
                }
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 5, "color": "yellow" },
                  { "value": 10, "color": "red" }
                ]
              }
            }
          }
        },
        {
          "id": 202,
          "title": "Loki Query Status",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 22 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(loki_request_duration_seconds_bucket{namespace=\"observability\", route=~\".*query.*\"}[5m])))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 5, "color": "yellow" },
                  { "value": 10, "color": "red" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "area",
            "colorMode": "background",
            "textMode": "value_and_name"
          }
        },
        {
          "id": 203,
          "title": "Filesystem Storage Decision",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 22 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(loki_request_duration_seconds_bucket{namespace=\"observability\", route=~\".*query.*\"}[5m])))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "mappings": [
                {
                  "type": "range",
                  "options": {
                    "from": 0,
                    "to": 5,
                    "result": {
                      "text": "‚úÖ Keep Filesystem",
                      "color": "green"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 5,
                    "to": 10,
                    "result": {
                      "text": "‚ö†Ô∏è Monitor",
                      "color": "yellow"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 10,
                    "to": 999999,
                    "result": {
                      "text": "üî¥ Consider MinIO",
                      "color": "red"
                    }
                  }
                }
              ]
            }
          },
          "options": {
            "graphMode": "none",
            "colorMode": "background",
            "textMode": "name"
          }
        },
        {
          "id": 204,
          "title": "Loki Ingester Flush Queue - Threshold: 100",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 26 },
          "targets": [
            {
              "expr": "loki_ingester_flush_queue_length{namespace=\"observability\"}",
              "legendFormat": "Flush queue length",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10,
                "thresholdsStyle": {
                  "mode": "line"
                }
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 100, "color": "yellow" },
                  { "value": 200, "color": "red" }
                ]
              }
            }
          }
        },
        {
          "id": 205,
          "title": "Loki Storage Usage & Growth",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 30 },
          "targets": [
            {
              "expr": "sum(loki_ingester_chunks_stored{namespace=\"observability\"}) * 2.5 / 1024 / 1024 / 1024",
              "legendFormat": "Estimated storage (GB)",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "gbytes",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10
              }
            }
          }
        },
        {
          "id": 206,
          "title": "Loki Daily Growth Rate",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 30 },
          "targets": [
            {
              "expr": "increase(loki_ingester_chunks_stored_total{namespace=\"observability\"}[24h]) * 2.5 / 1024 / 1024 / 1024",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "gbytes",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 1, "color": "yellow" },
                  { "value": 2, "color": "red" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "area",
            "colorMode": "background",
            "textMode": "value_and_name"
          }
        },
        {
          "id": 207,
          "title": "Storage Growth Decision",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 30 },
          "targets": [
            {
              "expr": "increase(loki_ingester_chunks_stored_total{namespace=\"observability\"}[24h]) * 2.5 / 1024 / 1024 / 1024",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "mappings": [
                {
                  "type": "range",
                  "options": {
                    "from": 0,
                    "to": 1,
                    "result": {
                      "text": "‚úÖ Sustainable",
                      "color": "green"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 1,
                    "to": 2,
                    "result": {
                      "text": "‚ö†Ô∏è Monitor",
                      "color": "yellow"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 2,
                    "to": 999999,
                    "result": {
                      "text": "üî¥ Too Fast",
                      "color": "red"
                    }
                  }
                }
              ]
            }
          },
          "options": {
            "graphMode": "none",
            "colorMode": "background",
            "textMode": "name"
          }
        },
        {
          "id": 208,
          "title": "Loki Ingestion Rate",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 34 },
          "targets": [
            {
              "expr": "sum(rate(loki_distributor_bytes_received_total{namespace=\"observability\"}[5m])) / 1024 / 1024",
              "legendFormat": "Ingestion rate (MB/s)",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "MBs",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10
              }
            }
          }
        },
        {
          "id": 300,
          "title": "Grafana Performance",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 42 },
          "collapsed": false
        },
        {
          "id": 301,
          "title": "Dashboard Load Time (p95) - Threshold: 3s",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 43 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(grafana_api_dashboard_get_duration_seconds_bucket{namespace=\"observability\"}[5m])))",
              "legendFormat": "p95 dashboard load time",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10,
                "thresholdsStyle": {
                  "mode": "line"
                }
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 3, "color": "yellow" },
                  { "value": 5, "color": "red" }
                ]
              }
            }
          }
        },
        {
          "id": 302,
          "title": "Dashboard Load Status",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 6, "x": 12, "y": 43 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(grafana_api_dashboard_get_duration_seconds_bucket{namespace=\"observability\"}[5m])))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" },
                  { "value": 3, "color": "yellow" },
                  { "value": 5, "color": "red" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "area",
            "colorMode": "background",
            "textMode": "value_and_name",
            "reduceOptions": {
              "calcs": ["lastNotNull"]
            }
          }
        },
        {
          "id": 303,
          "title": "Grafana Performance Status",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 6, "x": 18, "y": 43 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(grafana_api_dashboard_get_duration_seconds_bucket{namespace=\"observability\"}[5m])))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "mappings": [
                {
                  "type": "range",
                  "options": {
                    "from": 0,
                    "to": 3,
                    "result": {
                      "text": "‚úÖ Fast",
                      "color": "green"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 3,
                    "to": 5,
                    "result": {
                      "text": "‚ö†Ô∏è Acceptable",
                      "color": "yellow"
                    }
                  }
                },
                {
                  "type": "range",
                  "options": {
                    "from": 5,
                    "to": 999999,
                    "result": {
                      "text": "üî¥ Slow",
                      "color": "red"
                    }
                  }
                }
              ]
            }
          },
          "options": {
            "graphMode": "none",
            "colorMode": "background",
            "textMode": "name"
          }
        },
        {
          "id": 304,
          "title": "Grafana Active Users",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 51 },
          "targets": [
            {
              "expr": "grafana_stat_totals_dashboard{namespace=\"observability\"}",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "color": { "mode": "thresholds" },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "value": 0, "color": "green" }
                ]
              }
            }
          },
          "options": {
            "graphMode": "none",
            "textMode": "value_and_name"
          }
        },
        {
          "id": 305,
          "title": "Grafana API Request Rate",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 18, "x": 6, "y": 51 },
          "targets": [
            {
              "expr": "sum(rate(grafana_api_response_status_total{namespace=\"observability\"}[5m])) by (status_code)",
              "legendFormat": "{{status_code}}",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "color": { "mode": "palette-classic" },
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 10
              }
            }
          }
        }
      ]
    }
