---
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-alerting-rules
  namespace: observability
  labels:
    loki_rule: "1"
data:
  home-automation-alerts.yaml: |
    groups:
      - name: troy-backup-alerts
        interval: 5m
        rules:
          # Alert if no successful backup in the last 25 hours
          - alert: TroyBackupNoSuccessfulBackup
            expr: |
              (count_over_time({namespace="home-automation", container="troy-backup"} |= "Backup completed successfully" [25h]) OR on() vector(0)) == 0
            for: 1h
            labels:
              severity: critical
              service: troy-backup
              namespace: home-automation
            annotations:
              summary: "Troy backup has not completed successfully in 25+ hours"
              description: "No successful backup completion message found in the last 25 hours for troy-backup container."
              dashboard: "https://grafana.techvomit.xyz/d/troy-backup-monitoring"

          # Alert on backup failures/errors
          - alert: TroyBackupFailure
            expr: |
              rate({namespace="home-automation", container="troy-backup", level="error"} [10m]) > 0
            for: 5m
            labels:
              severity: critical
              service: troy-backup
              namespace: home-automation
            annotations:
              summary: "Troy backup job has encountered errors"
              description: "Backup errors detected in troy-backup container logs."
              dashboard: "https://grafana.techvomit.xyz/d/troy-backup-monitoring"

      - name: throwingshade-alerts
        interval: 2m
        rules:
          # Alert on high error rate (more than 5 errors in 6 hours)
          - alert: ThrowingshadeHighErrorRate
            expr: |
              count_over_time({namespace="home-automation", app_name="home-assistant", level="ERROR"} |= "throwingshade" [6h]) > 5
            for: 10m
            labels:
              severity: warning
              service: throwingshade
              namespace: home-automation
            annotations:
              summary: "Throwingshade error rate is high"
              description: "More than 5 throwingshade errors detected in the last 6 hours ({{ $value }} errors)."
              dashboard: "https://grafana.techvomit.xyz/d/throwingshade-operations"

          # Alert on critical error rate (more than 20 errors in 6 hours)
          - alert: ThrowingshadeCriticalErrorRate
            expr: |
              count_over_time({namespace="home-automation", app_name="home-assistant", level="ERROR"} |= "throwingshade" [6h]) > 20
            for: 5m
            labels:
              severity: critical
              service: throwingshade
              namespace: home-automation
            annotations:
              summary: "Throwingshade error rate is critical"
              description: "More than 20 throwingshade errors detected in the last 6 hours ({{ $value }} errors)."
              dashboard: "https://grafana.techvomit.xyz/d/throwingshade-operations"

      - name: home-assistant-alerts
        interval: 1m
        rules:
          # Alert on Home Assistant restart
          - alert: HomeAssistantRestart
            expr: |
              rate({namespace="home-automation", app_name="home-assistant"} |~ "(?i)(starting|started|home assistant.*start)" [2m]) > 0
            for: 30s
            labels:
              severity: info
              service: home-assistant
              namespace: home-automation
            annotations:
              summary: "Home Assistant has restarted"
              description: "Home Assistant service restart detected in logs."
              dashboard: "https://grafana.techvomit.xyz/d/home-automation-logs-overview"

          # Alert on Home Assistant high error rate
          - alert: HomeAssistantHighErrorRate
            expr: |
              rate({namespace="home-automation", app_name="home-assistant", level=~"ERROR|error"} [15m]) > 0.5
            for: 10m
            labels:
              severity: warning
              service: home-assistant
              namespace: home-automation
            annotations:
              summary: "Home Assistant error rate is elevated"
              description: "Home Assistant is logging errors at a rate of {{ $value }} errors/second over the last 15 minutes."
              dashboard: "https://grafana.techvomit.xyz/d/home-automation-logs-overview"
