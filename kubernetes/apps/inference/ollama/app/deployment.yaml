---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ollama
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ollama
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ollama
    spec:
      automountServiceAccountToken: false
      nodeSelector:
        node-role.kubernetes.io/storage: "true"
      initContainers:
        - name: model-puller
          image: ollama/ollama:latest
          resources:
            requests:
              cpu: "1"
              memory: 8Gi
            limits:
              cpu: "4"
              memory: 22Gi
          command:
            - /bin/sh
            - -c
            - |
              ollama serve &
              sleep 5
              ollama pull qwen2.5-coder:32b-instruct
              pkill ollama || true
          volumeMounts:
            - name: models
              mountPath: /root/.ollama
      containers:
        - name: ollama
          image: ollama/ollama:latest
          ports:
            - containerPort: 11434
              name: http
          env:
            - name: OLLAMA_CONTEXT_LENGTH
              value: "8192"
            - name: OLLAMA_DEBUG
              value: "true"
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 2
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
          resources:
            requests:
              cpu: "2"
              memory: 16Gi
            limits:
              cpu: "6"
              memory: 24Gi
          volumeMounts:
            - name: models
              mountPath: /root/.ollama
      volumes:
        - name: models
          persistentVolumeClaim:
            claimName: ollama-models
